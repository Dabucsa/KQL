// Detectar nuevos usuarios y logins (posible backdoor)
Event
| where TimeGenerated >= ago(24h)
| where EventLog == "Application"
| where Source has_any ("MSSQLSERVER","MSSQL$","SQLSERVERAGENT")
| where EventID in (33205, 33206)
| where RenderedDescription has_any (
    "CREATE USER",
    "CREATE LOGIN",
    "sp_addlogin",
    "sp_grantlogin",
    "ADD MEMBER",
    "sp_addrolemember",
    "sp_addsrvrolemember"
)
| extend Executor = coalesce(
    extract(@"principal_name=([^;,\s]+)", 1, RenderedDescription),
    extract(@"login_name=([^;,\s]+)", 1, RenderedDescription)
)
| extend NewUser = coalesce(
    extract(@"CREATE\s+(?:USER|LOGIN)\s+\[?([^\]\s]+)\]?", 1, RenderedDescription),
    extract(@"@loginame\s*=\s*N?'([^']+)'", 1, RenderedDescription),
    extract(@"member_name=([^;,\s]+)", 1, RenderedDescription)
)
| extend Role = coalesce(
    extract(@"role_name=([^;,\s]+)", 1, RenderedDescription),
    extract(@"FOR\s+LOGIN\s+\[?([^\]]+)\]?", 1, RenderedDescription)
)
| extend Accion = case(
    RenderedDescription has "CREATE USER", "CREATE_USER",
    RenderedDescription has "CREATE LOGIN", "CREATE_LOGIN",
    RenderedDescription has "sp_addlogin", "CREATE_LOGIN",
    RenderedDescription has "ADD MEMBER" or RenderedDescription has "sp_addrolemember", "ADD_TO_ROLE",
    "OTHER"
)
| extend Severity = case(
    Role in ("sysadmin", "securityadmin"), "CRITICAL",
    Accion in ("CREATE_LOGIN", "CREATE_USER"), "HIGH",
    "MEDIUM"
)
| extend ActionResult = iff(EventID == 33205, "SUCCESS", "FAILURE")
| extend BaseDatos = extract(@"database_name=([^;,\s]+)", 1, RenderedDescription)
| where isnotempty(NewUser)
| project 
    TimeGenerated,
    Computer,
    Severity,
    Accion,
    ActionResult,
    Executor,
    NewUser,
    Role,
    BaseDatos,
    EventID,
    RenderedDescription
| order by Severity desc, TimeGenerated desc
