Event
| where TimeGenerated >= ago(24h)
| where EventLog == "Application"
| where Source has_any ("MSSQLSERVER","MSSQL$","SQLSERVERAGENT")
| where EventID in (33205, 33206)  // 33205=SUCCESS, 33206=FAILURE
// Foco en seguridad a nivel servidor (securityadmin)
| where RenderedDescription has "securityadmin"
| where RenderedDescription has_any ("DROP MEMBER", "sp_droprolemember", "sp_dropsrvrolemember", "ALTER SERVER ROLE")
// Parseo de campos Ãºtiles
| extend Executor = coalesce(
    extract(@"principal_name=([^;,\s]+)", 1, RenderedDescription),
    extract(@"login_name=([^;,\s]+)", 1, RenderedDescription)
)
| extend UserRemoved = coalesce(
    extract(@"member_name=([^;,\s]+)", 1, RenderedDescription),
    extract(@"\bDROP\s+MEMBER\s+\[?([^\]\s]+)\]?", 1, RenderedDescription),
    extract(@"target_principal_name=([^;,\s]+)", 1, RenderedDescription)
)
| extend ActionResult = case(EventID == 33205, "SUCCESS", EventID == 33206, "FAILURE", "UNKNOWN")
| project TimeGenerated, Computer, Action="REMOVE_FROM_securityadmin", ActionResult, Executor, UserRemoved, EventID, Source, RenderedDescription
| order by TimeGenerated desc
